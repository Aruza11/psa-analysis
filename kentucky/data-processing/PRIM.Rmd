---
title: "PRIM"
author: "Bin Han"
date: "May 2, 2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, warning=FALSE, message=FALSE}
library(dplyr)
library(tidyverse)
library(data.table)
```

### Data path
```{r}
data_path = "../data/raw/"
```




### Load PRIM data

```{r}
## defendants
Defendants = as.data.frame(fread(paste0(data_path,'01_KY_Recidivism_Defendants.txt'), 
                                 header = T)) %>% 
                select(PersonID, Gender, Race) %>%
                rename(person_id = PersonID,
                       sex = Gender,
                       race= Race)
## interviews
Interviews = as.data.frame(fread(paste0(data_path,'02_KY_Recidivism_Interviews.txt'))) %>% 
    rename(person_id = PersonId, 
           InterviewID = InterviewId, 
           Interview_Date_Created = DateCreated)

## cases
PRIM_cases = as.data.frame(fread(paste0(data_path,'04_KY_Recidivism_PRIM_Cases.txt'))) %>%
    rename(person_id = PersonID,
           seq_case_id = SeqCaseId, 
           Case_Date_Booked = date_booked, 
           Age_at_Case_Booked = Age_at_Booking) %>%
    filter(County != "WHITLEY")


## charges
PRIM_charges = as.data.frame(fread(paste0(data_path,'07_KY_Recidivism_PRIM_Charges.txt'))) %>%
    rename(InterviewID = interviewID, 
           person_id = PersonId, 
           seq_case_id = SeqCaseID,
           CaseID = CaseId, 
           Charge_DispositionDate = DispositionDate) %>% 
    filter(County != "WHITLEY")


## bonds
Bonds = as.data.frame(fread(paste0(data_path,'09_KY_Recidivism_Bonds.txt'))) %>% 
    rename(InterviewID = interviewID, 
           person_id = PersonId, 
           CaseID = CaseId)%>% 
    filter(County != "WHITLEY")

## events
Events = as.data.frame(fread(paste0(data_path,'10_KY_Recidivism_Events.txt'))) %>% 
    rename(InterviewID = InterviewId,
           person_id = PersonId, 
           CaseID = Caseid,
           seq_case_id = SeqCaseid) %>% 
    filter(EventCounty != "WHITLEY")

## fta
FTA = as.data.frame(fread(paste0(data_path,'11_KY_Recidivism_FTA.txt'))) %>% 
    rename(InterviewID = InterviewId, 
           person_id = PersonId, 
           CaseID = Caseid, 
           seq_case_id = SeqCaseid)

## supervision
Supervision = as.data.frame(fread(paste0(data_path,'12_KY_Recidivism_Supervision.txt'))) %>% 
  rename(InterviewID = InterviewId, 
         person_id = PersonId, 
         CaseID = Caseid)
```





### EDA
##### 1. Defendants ################################################################################

The original data contains PersonID, Gender, Race, and Ethnicity. We only need PersonID and Gender.

```{r}
colnames(Defendants)
```

```{r}
summary(Defendants)
```

```{r}
length(unique(Defendants$person_id)) == nrow(Defendants)
```

__NOTE__:

Eahc row has an unique PersonID, representing a unique defendant.





##### 2. Interview ################################################################################

```{r}
colnames(Interviews)
```

```{r}
Interviews = Interviews %>% 
    select(-HoldingCountyCode, -County, -RiskLevel, -RiskScore, -HasHolder, -PostedPrior) 
    
```

__NOTE__:

Remove some variables to reduce dimension before joining tables.


```{r}
summary(Interviews)
```

```{r}
length(unique(Interviews$person_id)) == nrow(Interviews)
Interviews %>% group_by(person_id) %>% summarise(count = n()) %>% arrange(desc(count))
Interviews %>% group_by(person_id, InterviewID) %>% summarise(count = n()) %>% arrange(desc(count))
```

__NOTE__:

Each person (person_id) could correspond to several interviews. But the combination of person_id and InterviewID is unique.

```{r}
Interviews[Interviews$person_id == "28566", ]
```







##### 3. Cases ################################################################################

```{r}
colnames(PRIM_cases)
```


```{r}
summary(PRIM_cases)
PRIM_cases[is.na(PRIM_cases$InterviewID), ]
```

```{r}
hist(PRIM_cases$Age_at_Case_Booked)
sort(unique(PRIM_cases$Age_at_Case_Booked))
sum(PRIM_cases$Age_at_Case_Booked >= 80)
```

__NOTE__:
1. There are 3 NA's on InterviewID, CaseID, Age_at_Case_Booked. Same three. Error.
2. Max age_at_case_booked: 237. And there are 6369 people with age at case booked > 80. Error?




```{r}
PRIM_cases = PRIM_cases %>% 
    select(-CountyCode, -AlternativeReleaseType, AlternativeReleaseDate, -Mcr, -McrDate) %>% 
    filter(!is.na(InterviewID))
```

__NOTE__:
Remove some unwanted features to reduce dimension.

```{r}
length(unique(PRIM_cases$CaseID)) == nrow(PRIM_cases)
length(unique(PRIM_cases$seq_case_id)) == nrow(PRIM_cases)
```

__NOTE__:
Each row is an unique case with CaseID. But seq_case_id has some repeated appearance. It indicates that each seq_case_id could relate to several CaseID's.


```{r}
PRIM_cases %>% group_by(person_id, InterviewID) %>% summarise(count = n()) %>% arrange(desc(count))
```

```{r}
PRIM_cases[PRIM_cases$person_id == "110149" & PRIM_cases$InterviewID == "686821", ]
```

```{r}
PRIM_cases %>% group_by(person_id, InterviewID, CaseID) %>% summarise(count = n()) %>% arrange(desc(count))
```

```{r}
PRIM_cases %>% group_by(person_id, InterviewID, seq_case_id) %>% summarise(count = n()) %>% arrange(desc(count))
```

```{r}
PRIM_cases[PRIM_cases$person_id == "409241" & PRIM_cases$InterviewID == "1375331" & PRIM_cases$seq_case_id == "1719208", ]
```

```{r}
PRIM_cases %>% group_by(person_id, seq_case_id) %>% summarise(count = n()) %>% arrange(desc(count))
```

```{r}
e = PRIM_cases[PRIM_cases$person_id == "152948" & PRIM_cases$seq_case_id == "913837", ]
```


__Insights__:
1. Same person, same interview, could correspond to the different seq_case_id.
2. Same person, same interview, same seq_case_id, could have different CaseIDs.
3. Same person, same seq_case_id, could correspond to multiple interview.





##### 4. Charges ################################################################################

```{r}
colnames(PRIM_charges)
```

```{r}
summary(PRIM_charges)
```









##### 5.Bonds ################################################################################
```{r}
colnames(Bonds)
```

```{r}
summary(Bonds)
```







###### Combine files ########################################################################

### 1. defendants + interviews
```{r}
comb1 = merge(x=Defendants, y=Interviews, by="person_id")
nrow(comb1) == nrow(Interviews)
```

__NOTE__:
No information lost or added. 

```{r}
colnames(comb1)
```








### 2. comb1 + PRIM_cases
```{r}
## inner join
comb2 = merge(x=comb1, y=PRIM_cases, by=c("person_id", "InterviewID"))
nrow(comb2) == nrow(PRIM_cases)
```

__NOTE__:
No information added or lost.


```{r}
colnames(comb2)
```

__Summary__:

1. "comb2" contains all the interview and case information in PRIM, that could be related to the CourtNet cases.

2. 5000+ records have age over 90+. Prob typo.

"comb2" with be continuously merged with other files including "Bonds", "Events", "FTA" etc, then merged with the CNet files, which already contains charges information from CNet. "PRIM_unique_charge" will also be merged with the rest files and then row-binded to the file generated above.


### comb2 + PRIM_charges
```{r}
comb3 = merge(x=comb2, 
              y=PRIM_charges,
              by = c("person_id", "InterviewID", "CaseID", "seq_case_id"))
```

```{r}
a = comb3 %>% 
    group_by(person_id, seq_case_id, InterviewID, CaseID) %>% 
    summarise(count = n()) %>% 
    arrange(desc(count))
b = a[a$count>1, ]
sum(b$count - 1) == (nrow(comb3) - nrow(comb2))
```

__NOTE__: Extra records added. It is because each case could have multiple charges. Sanity check conducted above.

```{r}
colnames(comb3)
```

```{r}
comb3 = comb3 %>% 
    select(-County.y,
           -Division.y,
           -CaseNumberType.y) %>% 
    mutate(County = County.x,
           Divison = Division.x,
           CaseNumberType = CaseNumberType.x)
```



```{r}
PRIM_cases = comb2
PRIM_charges = comb3
PRIM_bond = Bonds
save(PRIM_cases, file = "../data/processed/PRIM_Cases.RData")
save(PRIM_charges, file = "../data/processed/PRIM_Charges.RData")
save(PRIM_bond, file = "../data/processed/PRIM_Bonds.RData")
```


