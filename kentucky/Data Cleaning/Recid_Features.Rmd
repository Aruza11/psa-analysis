---
title: "Features"
author: "Bin Han"
date: "June 23, 2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, warning=FALSE, message=FALSE}
library(dplyr)
library(tidyverse)
library(purrr)

load("CNet.RData")
load("PRIM_Cases.RData")
load("PRIM_Charges.RData")
load("PRIM_Bonds.RData")
```


###### CourNet Data ##############################################################################

## 1. Pre-processing

Get ride of some redundant variables that are not necessary for prediction (add back when needed). Since we will merge this CourtNet data set with the PRIM data set based on case level, we get rid of CourNet cases that have no appearance in the PRIM system. If the value of "PRIM" is 0, the case is excluded from the data.

- Case_FilingDate: CourtNet case filing date
- Age_at_Casing Filing: age at courtnet case file
- ChargeDate: courtnet charge date
- UOR_Description: charge description
- UOR_Level: charge level
- sentence: category of sentence
- SentMonths: total prison or jail time of a sentence in months

```{r}
CNet = CNet_data %>% select(PersonID, SeqCaseID, Gender, PRIM,  
                            Case_FilingDate, Age_at_Case_Filing,
                            ChargeEntityNumber, ChargeDate, UOR_Description, UOR_Level,
                            SentenceEntityNumber, sentence, SentMonths)%>%  
    filter(PRIM == 1, 
           UOR_Level %in%  c("MISDEMEANOR", "FELONY", "OTHER")) %>% 
    mutate(UOR_Description = toupper(UOR_Description))
```


## 2. Add basic features

- is_violence
- is_felony
- is_misdemeanor
- is_property
- is_murder
- is_assault
- is_family_violence (None)
- is_sex_offense
- is_weapon
- is_fel_prop_violence
- is_fel_assult
- is_misdemeanor_assault
- is_traffic
- is_drug
- is_dui
- is_domestic_violence
- is_stalking
- is_voyeurism
- is_fraud
- is_stealing/theft
- is_trespass

__NOTE__:

- The Case_NumberType does not match with the UOR charge level. Decided to proceed with the UOR level.
- It is not very precise to simply use key word to find what type of crime the charge is involved in. May need some future adjustment.

```{r}
CNet_features = CNet %>% 
    mutate(
        
        ## type of crime the charge is involved in
        is_violence = ifelse(str_detect(UOR_Description, "VIOLENCE"), 1, 0),
        
        is_felony = ifelse(UOR_Level == "FELONY", 1, 0),
        is_misdemeanor = ifelse(UOR_Level == "MISDEMEANOR", 1,0),
        is_property = ifelse(str_detect(UOR_Description, "PROPERTY"), 1, 0),
        is_murder = ifelse(str_detect(UOR_Description, "MURDER"), 1, 0),
        is_assault = ifelse(str_detect(UOR_Description, "ASSAULT"), 1, 0),
        
        is_sex_offense = ifelse(str_detect(UOR_Description, "SEX"), 1, 0),
        is_weapon = ifelse(str_detect(UOR_Description, "WEAPON"), 1, 0),
        is_fel_prop_viol = ifelse(is_felony == 1 & is_property == 1 & is_violence == 1, 1, 0),
        is_fel_assult = ifelse(is_felony == 1 & is_assault==1, 1, 0),
        is_misde_assult = ifelse(is_misdemeanor == 1 & is_assault==1, 1, 0),
        
        is_traffic = ifelse(UOR_Level == "TRAFFIC", 1,0),
        is_drug = ifelse(str_detect(UOR_Description, "DRUG"), 1, 0),
        is_dui = ifelse(str_detect(UOR_Description, "DUI"), 1, 0),
        is_demostic_violence = ifelse(str_detect(UOR_Description, "DOMESTIC VIOLENCE"), 1, 0),
        is_stalking = ifelse(str_detect(UOR_Description, "STALKING"), 1, 0),
        is_voyeurism = ifelse(str_detect(UOR_Description, "VOYEURISM"), 1, 0),
        is_fraud = ifelse(str_detect(UOR_Description, "FRAUD"), 1, 0),
        is_stealing = ifelse(str_detect(UOR_Description, "THEFT"), 1, 0),
        is_trespass = ifelse(str_detect(UOR_Description, "TRESPASS"), 1, 0),
        
        ## prison / jail sentence information
        jail = ifelse(is.na(sentence), 0, ifelse(sentence == "Jail Time", 1, 0)),
        prison = ifelse(is.na(sentence), 0, ifelse(sentence == "Prison Time", 1, 0)),
        SentMonths = ifelse(jail == 1 | prison == 1, SentMonths, 0)
    ) %>% ## further get rid of redundant variables
    select(-c(PRIM, UOR_Description, UOR_Level, sentence, SentenceEntityNumber))
```




###### PRIM Cases ######################################################################################

## 1. preprocessing

Get ride of some redundant variables that are not necessary for prediction (add back when needed). The "Fta" can be used to determine if the person failed to appear for this case or not. "RA1" features are cheat variables as criminal history.

__NOTE__:
One case in CourtNet should be matched exactlt to one case in PRIM, using SeqCaseID. The case booked date in PRIM system should be slightly later than the case booked date in the CourtNet system. However, there are multiple reasons why there are many caseIDs corresponding to one SeqCaseID in the PRIM system:

1. for the original case, the defandent may fail to appear. Then the defendant will be arrested again and a new interview and a new case will be created. The new CaseID in the PRIM system is still under the same SeqCaseID from the original case. 
   - PersonID == 5; SeqCaseID == 3046161

2. There are cases when multiple CaseID's are related to one SeqCaseID, which means that there should be more than one pretrial interview related to that one SeqCaseID based on the explanation. However, the interviewID is the same for all CaseID's. Anything wrong here? Is that because there are multiple charges?

The reason why we saw different risk scores for the child CaseID's of the same SeqCaseID is that if the FTA appears in the previous case, which is one the factors to calculate risk score, the risk score will definitely change. 



## Idea:
I plan to proceed with the CourtNet case (SeqCaseID), together with all the corresponding charges. When merged with PRIM system, if there are multiple CaseID's related, take the very first one that corresponds to the original case in CourtNet system, since the rest are due to fta or some other reasons. 




```{r}
PRIM_CASES = PRIM_cases %>% select(PersonID, SeqCaseID, CaseID, InterviewID,
                                   Case_Date_Booked, OnProbation, SupProbation, 
                                   Age_at_Case_Booked,Fta, ArrestType, ArrestOriginalCaseID, Rearrest) %>% 
    mutate(FTA = ifelse(Fta == "Y", 1, 0),
           probation = ifelse(OnProbation == "Y"|SupProbation == "Y", 1, 0)) %>% 
    select(-c(Fta,OnProbation,SupProbation))
```


```{r}
PRIM_CASES %>% group_by(PersonID, SeqCaseID) %>% summarise(count = n ()) %>% arrange(desc(count))
```


```{r}
a = PRIM_cases[PRIM_cases$PersonID== 409241 & PRIM_cases$SeqCaseID == 1719208, ]
b = CNet_features[CNet_features$PersonID == 409241 & CNet_features$SeqCaseID == 1719208, ]
```









###### PRIM Risk Score #################################################################################
```{r}
PRIM_Risk = PRIM_cases %>% select(PersonID, SeqCaseID, CaseID,
                                  fta_risk_score_raw, nca_risk_score_raw, 
                                  pvf_risk_score_raw, RA2_Current_Charge_Violent,
                                  RA2_Violent_and_under_21, RA2_Age_At_Interview,
                                  RA2_New_Charge_While_Case_Pending,
                                  RA2_Has_Prior_Misdemeanor, 
                                  RA2_Has_Prior_Felony,
                                  RA2_How_Many_FTA_Last_2_Yrs,
                                  RA2_Has_Any_FTA_Older_2_Yrs,
                                  RA2_Num_Prior_Violent,
                                  RA2_Has_Prior_Incarceration)
```


## Calculate risk scores
## FTA
```{r}
FTA = PRIM_Risk %>% 
  mutate(RA2_Has_Prior_Conviction = ifelse(RA2_Has_Prior_Misdemeanor=="2" & RA2_Has_Prior_Felony == "2", 0, 
                                    ifelse(RA2_Has_Prior_Misdemeanor == "1" |   RA2_Has_Prior_Felony=="1",1, NA)),
         RA2_New_Charge_While_Case_Pending = ifelse(RA2_New_Charge_While_Case_Pending == "1", 1, 
                                             ifelse(RA2_New_Charge_While_Case_Pending == "2", 0, NA)),
         RA2_How_Many_FTA_Last_2_Yrs = ifelse(RA2_How_Many_FTA_Last_2_Yrs == "1", 0,
                                       ifelse(RA2_How_Many_FTA_Last_2_Yrs == "2", 2,
                                       ifelse(RA2_How_Many_FTA_Last_2_Yrs == "3", 4, NA))),
         RA2_Has_Any_FTA_Older_2_Yrs = ifelse(RA2_Has_Any_FTA_Older_2_Yrs == "1", 1,
                                       ifelse(RA2_Has_Any_FTA_Older_2_Yrs == "2", 0, NA))) %>%
  select(RA2_New_Charge_While_Case_Pending, 
         RA2_Has_Prior_Conviction, 
         RA2_How_Many_FTA_Last_2_Yrs,
         RA2_Has_Any_FTA_Older_2_Yrs)

### Calculate Scores
FTA$Score = apply(FTA, 1, sum)
```


## NCA
```{r}
### Pick NCA Features
NCA = PRIM_Risk %>% 
  mutate(RA2_Age_At_Interview = ifelse(RA2_Age_At_Interview == "3", 0,
                                ifelse(RA2_Age_At_Interview == "NULL", NA, 2)),
         RA2_New_Charge_While_Case_Pending = ifelse(RA2_New_Charge_While_Case_Pending == "1", 3, 
                                             ifelse(RA2_New_Charge_While_Case_Pending == "2", 0, NA)),
         RA2_Has_Prior_Misdemeanor = ifelse(RA2_Has_Prior_Misdemeanor == "1", 1,
                                     ifelse(RA2_Has_Prior_Misdemeanor == "2", 0, NA)),
         RA2_Has_Prior_Felony = ifelse(RA2_Has_Prior_Felony == "1", 1,
                                ifelse(RA2_Has_Prior_Felony == "2", 0, NA)),
         RA2_Num_Prior_Violent = ifelse(RA2_Num_Prior_Violent == "1", 0,
                                 ifelse(RA2_Num_Prior_Violent == "2", 1,
                                 ifelse(RA2_Num_Prior_Violent == "3", 2, NA))),
         RA2_How_Many_FTA_Last_2_Yrs = ifelse(RA2_How_Many_FTA_Last_2_Yrs == "1", 0,
                                       ifelse(RA2_How_Many_FTA_Last_2_Yrs == "2", 1,
                                       ifelse(RA2_How_Many_FTA_Last_2_Yrs == "3", 2, NA))),
         RA2_Has_Prior_Incarceration = ifelse(RA2_Has_Prior_Incarceration == "1", 2,
                                       ifelse(RA2_Has_Prior_Incarceration == "2", 0, NA))) %>%
  select(RA2_Age_At_Interview, RA2_New_Charge_While_Case_Pending, RA2_Has_Prior_Felony,
         RA2_Has_Prior_Misdemeanor, RA2_Num_Prior_Violent, RA2_How_Many_FTA_Last_2_Yrs,
         RA2_Has_Prior_Incarceration)

## Calculate unweighted Score
NCA$Score = apply(NCA, 1, sum)
```


## NVCA
```{r}
### pick up NVCA features
NVCA = PRIM_Risk %>% 
  mutate(RA2_Current_Charge_Violent = ifelse(RA2_Current_Charge_Violent == "2", 0, 
                                      ifelse(RA2_Current_Charge_Violent == "1", 2, NA)),
         RA2_Violent_and_under_21 = ifelse(RA2_Violent_and_under_21 == "2", 0,
                                    ifelse(RA2_Violent_and_under_21 == "1", 1, NA)),
         RA2_New_Charge_While_Case_Pending = ifelse(RA2_New_Charge_While_Case_Pending == "2", 0,
                                             ifelse(RA2_New_Charge_While_Case_Pending == "1",1, NA)),
         RA2_Has_Prior_Conviction = ifelse(RA2_Has_Prior_Misdemeanor=="2" & RA2_Has_Prior_Felony == "2", 0, 
                                    ifelse(RA2_Has_Prior_Misdemeanor == "1" |   RA2_Has_Prior_Felony=="1", 1, NA)),
         RA2_Num_Prior_Violent = ifelse(RA2_Num_Prior_Violent == "1", 0,
                                 ifelse(RA2_Num_Prior_Violent == "2", 1,
                                 ifelse(RA2_Num_Prior_Violent == "3", 2, NA)))) %>% 
  select(RA2_Current_Charge_Violent, 
         RA2_Violent_and_under_21,
         RA2_New_Charge_While_Case_Pending,
         RA2_Has_Prior_Conviction,
         RA2_Num_Prior_Violent)

## NVCA unweighted score
NVCA$Score = apply(NVCA, 1, sum)
```

```{r}
PRIM_Risk = PRIM_Risk %>% 
    select(PersonID, SeqCaseID, CaseID, 
           fta_risk_score_raw, nca_risk_score_raw, pvf_risk_score_raw) %>% 
    mutate(fta_calc = FTA$Score,
           nca_calc = NCA$Score,
           nvca_calc = NVCA$Score)

```






###### Combine PRIM data + CourtNet Data
```{r}
memory.limit(size=56000)
features = merge(x=CNet, y=PRIM_CASES, by=c("PersonID", "SeqCaseID"))
```

```{r}
a = features[features$PersonID == "5" & features$SeqCaseID == "3046161", ]
b = PRIM_CASES[PRIM_CASES$PersonID == "5"& PRIM_CASES$SeqCaseID == "3046161",]
c = CNet[CNet$PersonID == "5" & CNet$SeqCaseID == "3046161", ]
```


__NOTE__:
There are extra records added to the data set. It is because one SeqCaseID could relate to multiple CaseID's in the PRIM system. But since each Case in PRIM could take on different values including FTA, risk scores etc, I  decided to proceed with the PRIM case level. But notice that since multiple CaseID's might relate to one SeqCaseID, therefore, cases in PRIM that share the SeqCaseID will have the same charge information.


```{r}
charges = features %>% group_by(PersonID, CaseID) %>% nest(.key = "charge_PRIM_case_level")
```


```{r}
save(charges, file = "Recid_Features.RData")
```




## Concerns:
If we only want to test for the broward model, we actually do not need to combine CourtNet data with the PRIM system. Since we can get all the features from CourtNet data set (Should be possible, not exactly sure). But the RiskScore information and also cheated criminal history data comes from the PRIM system. If we want to test Arnold PSA algorithm and want to use the cheated criminal history data, we do need to combine the two systems together.   






###### Bond Features #################################################################################
```{r}
colnames(PRIM_bond)
```

## pre-processing

Individuals without any bail amount should not be in the data set. I used "CreditAmount" as the determining criteria. "Amount": Bond amount in dollars, when applicable; "CreditAmount": The amount of bail credit in dollars, when applicable.

If bail credit is 0 or NULL, then excluded from the data set.
```{r}
PRIM_BOND = PRIM_bond %>% select(-c(CaseNumberType, CountyCode, County,
                                    Division, BondID, BondDate, judge_code, Judge,
                                    IsReleased, DateReleased, CreditReason, Diversion,
                                    UniformSchedule, PilotRelease)) %>% 
    filter(CreditAmount > 0)


## factorize condictions
for (i in 9:28){
    PRIM_BOND[,i] = ifelse(PRIM_BOND[,i] == "N", 0, 1)
}
```

## sanity check
```{r}
PRIM_BOND %>% group_by(PersonID, CaseID) %>% summarise(count = n()) %>% arrange(desc(count))
```

```{r}
PRIM_BOND[PRIM_BOND$PersonID == "275932" & PRIM_BOND$CaseID == "1345299", ]
```




## merge with feature data sets
```{r}
Bond_features = merge(x=PRIM_BOND, y=features, by=c("PersonID", "CaseID")) %>% select(-SeqCaseID)
```

```{r}
bonds = Bond_features %>% group_by(PersonID, CaseID) %>% nest(.key = "bond")
```

```{r}
save(bonds, file = "Bond_Features.RData")
```

