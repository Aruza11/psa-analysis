---
title: "feature_subset_selection"
author: 
date: 1/14/2019
output: html_document
---

Here we use xgBoost to evaluate feature subset selections

```{r include = FALSE}
library(tidyverse)
library(magrittr)
library(pROC)

library(xgboost)
source('util.R')
```

Load in train/test datasets computed/saved in predict_recidivism.Rmd
```{r}
train <- readRDS(file="train.rds")
test <- readRDS(file="test.rds")
```


```{r}
# Specify each parameter as a single value or a vector of values
# Each combination will be tested
param_xgb <- list(
  objective = "binary:logistic",
  eta = c(.05,.1),
  gamma = c(.5),
  max_depth = c(2),
  min_child_weight = c(5),
  subsample = c(1),
  colsample_bytree = c(1),
  early_stopping_rounds=50
)

param_xgb = expand.grid(param_xgb) # Each row is a set of parameters to be cross validated

# Only one value for each of these parameters is allowed
setup_xgb = list(
  nrounds=10000,
  nfold=5
)
```



##Baseline: all features 
```{r}
train_baseline = xgb.DMatrix(
  "data" = train %>% select(-recid_use) %>% as.matrix(),
  "label" = train %>% select(recid_use) %>% as.matrix()
)

set.seed(2812)
out_baseline = fit_xgb_auc(train_baseline, test, param_xgb, setup_xgb)
out_baseline$performance
plot(out_baseline$roc,
     print.auc = T,
     main = paste("XGBoost ROC curve using N = ", nrow(test), " , baseline"),
     legacy.axes = T,
     grid =T )
```


```{r}
names(train)
```

Subsets
```{r}
#seeds 
n_subsets <- 2
seeds <- sample.int(10000, n_subsets)

#Subset 1: features which capture petty offenses (reasoning: easy to recidivate)
subset1 <- c("p_current_age","p_charge", "p_traffic",  "p_drug", 
             "p_trespass","p_stealing", "p_misdemassault_arrest")

#sanity check
subset2 <- c("p_current_age")

#arnold var
subset3 <- c("p_current_age", )

```


```{r}
run_xgb <- function(subset_list, train, test, param, setup, seed){
  train_subset = xgb.DMatrix(
    "data" = train %>% 
              select(-recid_use)%>% #del label
              select(subset_list) %>%
              as.matrix(),
    "label" = train %>% select(recid_use) %>% as.matrix()
  )
  
  test_subset = test %>% select(subset_list, recid_use)
  
  set.seed(seed)
  out = fit_xgb_auc(train_subset, test_subset, param, setup)
  return(out)
}

```

```{r}

out = run_xgb(subset1, train, test, param_xgb, setup_xgb, seeds[1])
out$performance
plot(out$roc,
     print.auc = T,
     main = paste("XGBoost ROC curve using N = ", nrow(test), " , Subset 1"),
     legacy.axes = T,
     grid =T )

```








