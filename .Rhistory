library(stringr)
library(tidyverse)
library(magrittr)
library(lubridate)
library(reshape2)
data_path="../broward-data/"
load(paste0(data_path, "Table_construction.Rdata")) #loading beau's version of data
fta_prob<-read.csv(paste0(data_path,"fta_prob.csv"))
paste0(data_path,"fta_prob.csv")
# Load packages
library(tidyverse)
library(magrittr)
library(stringr)
library(xml2)
library(XML)
library(lubridate)
setwd("C:/Users/Caroline Wang/OneDrive/Duke/Criminal Recidivism")
eventsdescrp_df<-read.csv("Data tables/eventsdescrp_df1.csv")%>%
bind_rows(.,read.csv("Data tables/eventsdescrp_df2.csv"))%>%
bind_rows(.,read.csv("Data tables/eventsdescrp_df3.csv"))%>%
bind_rows(.,read.csv("Data tables/eventsdescrp_df4.csv"))
eventsdescrp_df<-read.csv(paste0(data_path, "eventsdescrp_df1.csv"))%>%
bind_rows(.,read.csv(paste0(data_path, "eventsdescrp_df2.csv")))%>%
bind_rows(.,read.csv(paste0(data_path, "eventsdescrp_df3.csv")))%>%
bind_rows(.,read.csv(paste0(data_path, "eventsdescrp_df1.csv")))
data_path = "../../broward-data/"
eventsdescrp_df<-read.csv(paste0(data_path, "eventsdescrp_df1.csv"))%>%
bind_rows(.,read.csv(paste0(data_path, "eventsdescrp_df2.csv")))%>%
bind_rows(.,read.csv(paste0(data_path, "eventsdescrp_df3.csv")))%>%
bind_rows(.,read.csv(paste0(data_path, "eventsdescrp_df1.csv")))
eventsdescrp_df$Description<-as.character(eventsdescrp_df$Description)
# View(head(eventsdescrp_df))
#All descriptions containing "probation"
# eventsdescrp_df%>%
#     filter(str_detect(Description,coll("Probation",T,ignore_case=T)))%>%
#     distinct(Description)
#failure to appear and probations
fta_prob<-eventsdescrp_df%>%
mutate(fail_appeared=if_else(str_detect(
Description,coll("D6 Failure To Appear",T,ignore_case=T))
==T,1,0),
prob_violation=case_when(str_detect(Description,coll(
"File Affidavit And Warrant Violation Of Probation",
T,ignore_case=T))~1,
str_detect(Description,coll(
"Violation Of Probation Withdrawn",T,
ignore_case=T))~-1,
str_detect(Description,coll(
"Violation Of Probation Warrant Dismissed",T,
ignore_case=T))~-1,
TRUE~0)
) %>%
select(person_id,EventDate,case_num,Description,fail_appeared, prob_violation)
# View(fta_prob)
# View(filter(fta_prob, Description=="File Affidavit And Warrant Violation Of Probation"|
#               Description=="Violation Of Probation Withdrawn"|
#               Description=="Violation Of Probation Warrant Dismissed"))
write.csv(fta_prob,paste0(data_path,"fta_prob.csv"))
setwd("C:/Users/Caroline Wang/OneDrive/Duke/Criminal Recidivism/broward-data")
write.csv(fta_prob,"fta_prob.csv")
rm(list=ls())
data_path="../broward-data/"
load(paste0(data_path, "Table_construction.Rdata")) #loading beau's version of data
fta_prob<-read.csv(paste0(data_path,"fta_prob.csv"))
data_path="C:/Users/Caroline Wang/OneDrive/Duke/Criminal Recidivism/broward-data/"
fta_prob<-read.csv(paste0(data_path,"fta_prob.csv"))
fta_prob<-read.csv("C:/Users/Caroline Wang/OneDrive/Duke/Criminal Recidivism/broward-data/fta_prob.csv")
rm(list=ls())
eventsdescrp_df<-read.csv(paste0(data_path, "eventsdescrp_df1.csv"))%>%
bind_rows(.,read.csv(paste0(data_path, "eventsdescrp_df2.csv")))%>%
bind_rows(.,read.csv(paste0(data_path, "eventsdescrp_df3.csv")))%>%
bind_rows(.,read.csv(paste0(data_path, "eventsdescrp_df1.csv")))
data_path = "../../broward-data/"
eventsdescrp_df<-read.csv(paste0(data_path, "eventsdescrp_df1.csv"))%>%
bind_rows(.,read.csv(paste0(data_path, "eventsdescrp_df2.csv")))%>%
bind_rows(.,read.csv(paste0(data_path, "eventsdescrp_df3.csv")))%>%
bind_rows(.,read.csv(paste0(data_path, "eventsdescrp_df1.csv")))
eventsdescrp_df$Description<-as.character(eventsdescrp_df$Description)
# View(head(eventsdescrp_df))
#All descriptions containing "probation"
# eventsdescrp_df%>%
#     filter(str_detect(Description,coll("Probation",T,ignore_case=T)))%>%
#     distinct(Description)
#failure to appear and probations
fta_prob<-eventsdescrp_df%>%
mutate(fail_appeared=if_else(str_detect(
Description,coll("D6 Failure To Appear",T,ignore_case=T))
==T,1,0),
prob_violation=case_when(str_detect(Description,coll(
"File Affidavit And Warrant Violation Of Probation",
T,ignore_case=T))~1,
str_detect(Description,coll(
"Violation Of Probation Withdrawn",T,
ignore_case=T))~-1,
str_detect(Description,coll(
"Violation Of Probation Warrant Dismissed",T,
ignore_case=T))~-1,
TRUE~0)
) %>%
select(person_id,EventDate,case_num,Description,fail_appeared, prob_violation)
# View(fta_prob)
# View(filter(fta_prob, Description=="File Affidavit And Warrant Violation Of Probation"|
#               Description=="Violation Of Probation Withdrawn"|
#               Description=="Violation Of Probation Warrant Dismissed"))
setwd("C:/Users/Caroline Wang/OneDrive/Duke/Criminal Recidivism/broward-data")
write.csv(fta_prob,"fta_prob.csv")
write.csv(fta_prob,"C:/Users/Caroline Wang/OneDrive/Duke/Criminal Recidivism/broward-data/fta_prob.csv")
write.csv(fta_prob,"C:/Users/Caroline Wang/OneDrive/Duke/Criminal Recidivism/fta_prob.csv")
fta_prob<-read.csv(paste0("../","fta_prob.csv"))
rm(eventsdescrp_df)
load(paste0(data_path, "Table_construction.Rdata")) #loading beau's version of data
data_path="C:/Users/Caroline Wang/OneDrive/Duke/Criminal Recidivism/broward-data/"
load(paste0(data_path, "Table_construction.Rdata")) #loading beau's version of data
View(head(fta_prob))
View(head(fta_prob))
View(data_before)
type(data_before$screening_date)
class(data_before$screening_date)
#data_on is df containing info for the current offense
current_violent = data_on %>%
select(person_id, screening_date, charge)%>%
filter(charge!="NULL")%>%
unnest() %>%
group_by(person_id, screening_date)%>%
current_violent = ifelse(sum(is_violent)>0, 1, 0)%>%
current_violent20 = ifelse(current_violent == 1 & age_offense <=20, 1, 0)
current_violent = data_on %>%
select(person_id, screening_date, charge)%>%
filter(charge!="NULL")%>%
unnest() %>%
group_by(person_id, screening_date)%>%
summarize()%>%
current_violent = ifelse(sum(is_violent)>0, 1, 0)%>%
current_violent20 = ifelse(current_violent == 1 & age_offense <=20, 1, 0)
current_violent = data_on %>%
select(person_id, screening_date, charge)%>%
filter(charge!="NULL")%>%
unnest() %>%
group_by(person_id, screening_date)%>%
summarize(current_violent = ifelse(sum(is_violent)>0, 1, 0),
current_violent20 = ifelse(current_violent == 1 & age_offense <=20, 1, 0))
current_violent = data_on %>%
select(person_id, screening_date, charge)%>%
filter(charge!="NULL")%>%
unnest() %>%
group_by(person_id, screening_date)%>%
summarize(current_violent = ifelse(sum(is_violent)>0, 1, 0),
current_violent20 = ifelse(current_violent == 1 & max(age_offense) <=20, 1, 0))
temp<-fta_prob%>%
distinct(person_id,EventDate,case_num,fail_appeared, prob_violation)%>%
rename(case_number=case_num)
temp$case_number=as.character(distinct_fta_prob$case_number)
temp$case_number=as.character(temp$case_number)
#data_on is df containing info for the current offense
current_violent = data_on %>%
select(person_id, screening_date, charge)%>%
filter(charge!="NULL")%>%
unnest() %>%
group_by(person_id, screening_date)%>%
summarize(current_violent = ifelse(sum(is_violent)>0, 1, 0),
current_violent20 = ifelse(current_violent == 1 & max(age_offense) <=20, 1, 0))
temp<-fta_prob%>%
distinct(person_id,EventDate,case_num,fail_appeared, prob_violation)%>%
rename(case_number=case_num)
temp$case_number=as.character(temp$case_number)
fta <-  data_before%>%
select(person_id,screening_date,charge)%>%
filter(charge!="NULL")%>%
unnest() %>%
select(person_id, screening_date, case_number)%>%
inner_join(temp,by=c("person_id","case_number"))%>%
mutate(EventDate=mdy(EventDate,tz="UTC"), #format = "%m/%d/%Y"
#mdy() fcn automatically converts to Date object, ymd_hms() function converts to POSIXt object, so
#specify tz="UTC" to get mdy() to convert to POSIXt object
days_bw=as.numeric(screening_date-EventDate,units="days"),
logical=days_bw<=730,
fail_appear_two_yr=if_else(logical&fail_appeared==1,1,0),
fail_appear_two_plus=if_else(!logical&fail_appeared==1,1,0)
)%>%
select(person_id,screening_date,case_number,fail_appear_two_yr,fail_appear_two_plus)%>%
group_by(person_id)%>%
summarise(fail_appear_two_yr=sum(fail_appear_two_yr),
fail_appear_two_plus=sum(fail_appear_two_plus),
)
psa_features = features%>%
select(p_current_age,
p_misdem_count_person,
p_felony_count_person,
p_prison)%>%
inner_join(fta, by=c("person_id", "screening_date"))%>%
inner_join(current_violent, by=c("person_id", "screening_date"))
View(head(fta))
rm(fta,temp,fta_prob)
convictions<-read.csv(paste0("../","convicted_from_disps.csv"))
convictions<-read.csv(paste0(data_path,"convicted_from_disps.csv"))
conv_subset <- convictions%>%
select(person_id, case_number,Charge,convicted,JudgementDate)%>%
rename(charge_number=Charge)%>%
mutate(JudgementDate=ymd(JudgementDate,tz="UTC"))%>%
group_by(case_number,charge_number)%>%
filter(JudgementDate==max(JudgementDate))
conv_subset <- convictions%>%
select(person_id, case_number,Charge,convicted,JudgementDate)%>%
rename(charge_number=Charge)%>%
mutate(JudgementDate=ymd(JudgementDate,tz="UTC"))%>%
group_by(case_number,charge_number)%>%
filter(JudgementDate==max(JudgementDate))
View(head(conv_subset))
conv_subset$case_number=as.character(conv_subset$case_number)
data_before$charge
conv_subset <- convictions%>%
select(person_id, case_number,Charge,convicted,JudgementDate)%>%
rename(charge_number=Charge)%>%
mutate(JudgementDate=ymd(JudgementDate,tz="UTC"))%>%
group_by(case_number,charge_number)%>%
filter(JudgementDate==max(JudgementDate))
conv_subset$case_number=as.character(conv_subset$case_number)
#want the latest disposition per case; some cases/charges have more than one disposition
prior_conv <- data_before%>%
select(person_id,screening_date,charge)%>%
filter(charge!="NULL")%>%
unnest() %>%
select(person_id, screening_date, case_number,charge_number,charge_degree,
is_violent, is_felony, is_misdem)%>%
inner_join(conv_subset, by=c("person_id","case_number","charge_number"))%>%
mutate(# is_traffic=if_else(charge_degree=="(0)"|charge_degree=="(TCX)",1,0),
days_bw=as.numeric(screening_date-offense_date,units="days"),
logical=days_bw<=730,
prior_conviction_F=if_else(is_felony==1&convicted==1,1,0),
prior_conviction_M=if_else(is_misdem==1&convicted==1,1,0),
# prior_conviction_T=if_else(is_traffic==1&convicted==1,1,0),
violent_conviction=if_else(is_violent==1&convicted==1,1,0))%>%
group_by(c(person_id,screening_date))%>%
summarise(prior_conviction_F=sum(prior_conviction_F),
prior_conviction_M=sum(prior_conviction_M),
# prior_conviction_T=sum(prior_conviction_T),
violent_conviction=sum(is_violent)
)
names(conv_subset)
prior_conviction_F=if_else(is_felony==1&convicted==1,1,0),
conv_subset <- convictions%>%
select(person_id, case_number,Charge,convicted,JudgementDate)%>%
rename(charge_number=Charge)%>%
mutate(JudgementDate=ymd(JudgementDate,tz="UTC"))%>%
group_by(case_number,charge_number)%>%
filter(JudgementDate==max(JudgementDate))
conv_subset <- convictions%>%
select(person_id, case_number,Charge,convicted,JudgementDate)%>%
rename(charge_number=Charge)%>%
mutate(JudgementDate=ymd(JudgementDate,tz="UTC"))%>%
group_by(case_number,charge_number)%>%
filter(JudgementDate==max(JudgementDate))
conv_subset$case_number=as.character(conv_subset$case_number)
#want the latest disposition per case; some cases/charges have more than one disposition
prior_conv <- data_before%>%
select(person_id,screening_date,charge)%>%
filter(charge!="NULL")%>%
unnest() %>%
select(person_id, screening_date, case_number,charge_number,charge_degree,
is_violent, is_felony, is_misdem)%>%
inner_join(conv_subset, by=c("person_id","case_number","charge_number"))%>%
mutate(# is_traffic=if_else(charge_degree=="(0)"|charge_degree=="(TCX)",1,0),
prior_conviction_F=if_else(is_felony==1&convicted==1,1,0),
prior_conviction_M=if_else(is_misdem==1&convicted==1,1,0),
# prior_conviction_T=if_else(is_traffic==1&convicted==1,1,0),
violent_conviction=if_else(is_violent==1&convicted==1,1,0))%>%
group_by(c(person_id,screening_date))%>%
summarise(prior_conviction_F=sum(prior_conviction_F),
prior_conviction_M=sum(prior_conviction_M),
# prior_conviction_T=sum(prior_conviction_T),
violent_conviction=sum(is_violent)
)
